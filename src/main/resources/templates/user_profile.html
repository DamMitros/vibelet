<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout(~{::content})}">
    <head><title>USER PROFILE</title></head>
    <body>
        <div th:fragment="content">

            <div class="neo-box p-0 bg-white mb-10 relative">
                <div class="h-32 bg-acid-purple border-b-[3px] border-black pattern-diagonal"></div>
                <div class="px-6 pb-6">
                    <div class="flex justify-between items-end -mt-12 mb-4">
                        <div class="w-24 h-24 bg-acid-yellow border-[3px] border-black overflow-hidden relative">
                            <img th:if="${targetUser.avatarUrl}" th:src="${targetUser.avatarUrl}" class="w-full h-full object-cover">
                            <div th:unless="${targetUser.avatarUrl}" class="w-full h-full flex items-center justify-center font-head text-4xl">?</div>
                        </div>

                        <div th:switch="${friendshipStatus}">
                            <div th:case="'SELF'">
                                <a th:href="@{/profile}" class="neo-btn bg-gray-200 hover:bg-black hover:text-white transition">EDIT PROFILE</a>
                            </div>
                            <div th:case="'NONE'">
                                <button th:onclick="'sendRequest(' + ${targetUser.id} + ')'" class="neo-btn bg-acid-green hover:shadow-neo-sm">
                                    <i class="fa-solid fa-user-plus mr-2"></i> ADD FRIEND
                                </button>
                            </div>
                            <div th:case="'PENDING_SENT'">
                                <button th:onclick="'removeFriend(' + ${friendshipId} + ')'" class="neo-btn bg-gray-300 hover:bg-red-500 hover:text-white transition">
                                    <i class="fa-solid fa-xmark mr-2"></i> CANCEL REQ
                                </button>
                            </div>
                            <div th:case="'PENDING_RECEIVED'">
                                <div class="flex gap-2">
                                    <button th:onclick="'acceptRequest(' + ${friendshipId} + ')'" class="neo-btn bg-acid-green">ACCEPT</button>
                                    <button th:onclick="'removeFriend(' + ${friendshipId} + ')'" class="neo-btn bg-red-500 text-white">REJECT</button>
                                </div>
                            </div>
                            <div th:case="'FRIEND'">
                                <button th:onclick="'removeFriend(' + ${friendshipId} + ')'" class="neo-btn bg-red-500 text-white hover:bg-black">
                                    <i class="fa-solid fa-user-minus mr-2"></i> UNFRIEND
                                </button>
                            </div>
                        </div>
                    </div>

                    <h1 class="font-head text-4xl uppercase" th:text="${targetUser.username}">USERNAME</h1>

                    <div class="flex gap-6 mt-4 font-mono text-sm border-b-[3px] border-black pb-4 mb-4">
                        <div><span class="font-bold text-xl" th:text="${vibeCount}">0</span> VIBES</div>
                        <div><span class="font-bold text-xl" th:text="${friendCount}">0</span> FRIENDS</div>
                    </div>

                    <div class="font-body text-lg border-[3px] border-black p-4 bg-off-white my-6 relative">
                        <span th:text="${targetUser.bio ?: 'NO DATA.'}">Bio...</span>
                    </div>
                </div>
            </div>

            <h2 class="font-head text-2xl mb-6 border-b-[3px] border-black inline-block bg-acid-yellow px-2">TRANSMISSIONS_LOG</h2>

            <div class="space-y-12">
                <article class="neo-box p-0 bg-white" th:each="vibe : ${vibes}" th:id="'vibe-' + ${vibe.id}">
                    <div class="border-b-[3px] border-black p-4 flex justify-between items-center bg-off-white">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 border-2 border-black bg-acid-yellow overflow-hidden">
                                <img th:if="${vibe.user.avatarUrl}" th:src="${vibe.user.avatarUrl}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <span class="font-head text-sm" th:text="${vibe.user.username}">USERNAME</span>
                                <span class="font-mono text-xs text-gray-500 ml-2" th:text="${#temporals.format(vibe.createdAt, 'HH:mm dd-MM')}">DATE</span>
                                <span class="font-mono text-[10px] border border-black px-1 ml-1" th:text="${vibe.privacyStatus}">PUBLIC</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4">
                        <p class="font-body font-bold text-xl mb-4 leading-tight" th:text="${vibe.content}">Content</p>
                    </div>

                    <div class="border-y-[3px] border-black" th:if="${vibe.imageUrl}">
                        <img th:src="@{'/uploads/' + ${vibe.imageUrl}}" class="w-full object-cover">
                    </div>

                    <div th:id="'comments-section-' + ${vibe.id}" class="hidden bg-gray-100 border-b-[3px] border-black p-4 text-sm font-mono">
                        <div class="space-y-2 mb-3">
                            <div th:if="${!#lists.isEmpty(vibe.comments)}" th:each="comment : ${vibe.comments}" class="border-l-2 border-black pl-2">
                                <span class="font-bold" th:text="${comment.user.username}">User</span>: <span th:text="${comment.content}">Text</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" th:id="'comment-input-' + ${vibe.id}" class="w-full border-2 border-black p-1" placeholder="REPLY...">
                            <button th:onclick="'postComment(' + ${vibe.id} + ')'" class="bg-black text-white px-2 font-bold">SEND</button>
                        </div>
                    </div>

                    <div class="p-4 flex gap-4 font-mono text-sm font-bold">
                        <button th:onclick="'toggleLike(' + ${vibe.id} + ')'" class="flex-1 py-2 border-[3px] border-black flex items-center justify-center gap-2 hover:bg-acid-pink transition bg-white">
                            <i th:id="'heart-icon-' + ${vibe.id}"
                               class="fa-solid fa-heart transition"
                               th:classappend="${#lists.contains(vibe.likes.![user.username], #authentication.name)} ? 'text-red-500' : ''">
                            </i>
                            <span th:id="'likes-count-' + ${vibe.id}" th:text="${vibe.likes.size()}">0</span>
                        </button>
                        <button th:onclick="'toggleComments(' + ${vibe.id} + ')'" class="flex-1 py-2 border-[3px] border-black flex items-center justify-center gap-2 hover:bg-acid-blue transition bg-white">
                            <i class="fa-solid fa-comment"></i> <span th:text="${vibe.comments.size()}">0</span>
                        </button>
                    </div>
                </article>

                <div th:if="${#lists.isEmpty(vibes)}" class="p-6 border-2 border-dashed border-black text-center font-mono text-gray-500">
                    USER HAS NOT SCREAMED INTO THE VOID YET.
                </div>
            </div>

            <script th:inline="javascript">
                /* --- OBSŁUGA ZNAJOMYCH --- */

                async function sendRequest(userId) {
                    try {
                        const res = await fetch(`/api/v1/friends/request/${userId}`, { method: 'POST' });
                        if (res.ok) location.reload();
                    } catch (e) { console.error(e); }
                }

                async function removeFriend(friendshipId) {
                    if(!confirm("Are you sure?")) return;
                    try {
                        const res = await fetch(`/api/v1/friends/${friendshipId}`, { method: 'DELETE' });
                        if(res.ok) location.reload();
                    } catch (e) { console.error(e); }
                }

                async function acceptRequest(friendshipId) {
                    try {
                        const res = await fetch(`/api/v1/friends/accept/${friendshipId}`, { method: 'PUT' });
                        if(res.ok) location.reload();
                    } catch (e) { console.error(e); }
                }

                /* --- OBSŁUGA VIBES (LAJKI I POKAZYWANIE KOMENTARZY) --- */

                async function toggleLike(vibeId) {
                    const icon = document.getElementById(`heart-icon-${vibeId}`);
                    const count = document.getElementById(`likes-count-${vibeId}`);

                    if (!icon || !count) return;

                    let isLiked = icon.classList.contains('text-red-500');
                    icon.classList.toggle('text-red-500');

                    let currentCount = parseInt(count.innerText) || 0;
                    count.innerText = Math.max(0, currentCount + (isLiked ? -1 : 1));

                    try {
                        await fetch(`/api/v1/interactions/vibe/${vibeId}/like`, { method: 'POST' });
                    } catch (e) { console.error(e); }
                }

                function toggleComments(vibeId) {
                    const section = document.getElementById(`comments-section-${vibeId}`);
                    if(section) section.classList.toggle('hidden');
                }

                async function postComment(vibeId) {
                    const input = document.getElementById(`comment-input-${vibeId}`);
                    const container = document.querySelector(`#comments-section-${vibeId} .space-y-2`);

                    if (!input || !input.value.trim()) return;

                    try {
                        const res = await fetch(`/api/v1/interactions/vibe/${vibeId}/comment`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: input.value })
                        });

                        if (res.ok) {
                            const data = await res.json();
                            const newCommentHtml = `
                    <div id="comment-row-${data.id}" class="border-l-2 border-black pl-2 flex justify-between items-start bg-white p-2 animate-pulse">
                        <div class="flex-1 mr-2">
                            <a href="/users/${data.userId}" class="font-bold hover:underline">${data.username}</a>:
                            <span id="comment-content-${data.id}">${data.content}</span>

                            <div id="comment-edit-box-${data.id}" class="hidden mt-1">
                                <input type="text" id="comment-edit-input-${data.id}" value="${data.content}" class="w-full border border-black px-1 text-xs">
                                <div class="mt-1 flex gap-1">
                                    <button onclick="saveEditComment(${data.id})" class="bg-black text-white px-1 text-[10px]">SAVE</button>
                                    <button onclick="cancelEditComment(${data.id})" class="bg-gray-200 px-1 text-[10px]">CANCEL</button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] text-gray-500 whitespace-nowrap">JUST NOW</span>

                            <div class="flex gap-1">
                                <button onclick="enableEditComment(${data.id})" class="text-[10px] hover:text-blue-600"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteComment(${data.id})" class="text-[10px] hover:text-red-600"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                    </div>
                `;

                            if (container) {
                                container.insertAdjacentHTML('beforeend', newCommentHtml);
                            }

                            input.value = '';
                            const btn = document.querySelector(`button[onclick="toggleComments(${vibeId})"] span`);
                            if(btn) btn.innerText = parseInt(btn.innerText) + 1;
                        }
                    } catch (e) { console.error(e); }
                }

                async function deleteComment(commentId) {
                    if(!confirm("Delete comment?")) return;
                    try {
                        const res = await fetch(`/api/v1/interactions/comment/${commentId}`, { method: 'DELETE' });
                        if (res.ok) {
                            const row = document.getElementById(`comment-row-${commentId}`);
                            if (row) row.remove();
                        }
                    } catch (e) { console.error(e); }
                }

                function enableEditComment(commentId) {
                    document.getElementById(`comment-content-${commentId}`).classList.add('hidden');
                    document.getElementById(`comment-edit-box-${commentId}`).classList.remove('hidden');
                }

                function cancelEditComment(commentId) {
                    document.getElementById(`comment-content-${commentId}`).classList.remove('hidden');
                    document.getElementById(`comment-edit-box-${commentId}`).classList.add('hidden');
                }

                async function saveEditComment(commentId) {
                    const input = document.getElementById(`comment-edit-input-${commentId}`);
                    const contentVal = input.value;

                    try {
                        const res = await fetch(`/api/v1/interactions/comment/${commentId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: contentVal })
                        });

                        if (res.ok) {
                            document.getElementById(`comment-content-${commentId}`).innerText = contentVal;
                            cancelEditComment(commentId);
                        }
                    } catch (e) { console.error(e); }
                }
            </script>
        </div>
    </body>
</html>